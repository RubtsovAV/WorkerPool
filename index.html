<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Workerpool by qxsch</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Workerpool</h1>
          <h2>Parallel Processing WorkerPool for PHP</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/qxsch/WorkerPool/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/qxsch/WorkerPool/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/qxsch/WorkerPool" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a name="workerpool-" class="anchor" href="#workerpool-"><span class="octicon octicon-link"></span></a>WorkerPool </h1>

<p><a href="https://travis-ci.org/qxsch/WorkerPool"><img src="https://travis-ci.org/qxsch/WorkerPool.svg?branch=master" alt="Build Status"></a>
<img src="http://stillmaintained.com/qxsch/WorkerPool.png" alt="Project Status"></p>

<p><a href="https://packagist.org/packages/qxsch/worker-pool"><img src="https://poser.pugx.org/qxsch/worker-pool/v/stable.png" alt="Latest Stable Version"></a> <a href="https://packagist.org/packages/qxsch/worker-pool"><img src="https://poser.pugx.org/qxsch/worker-pool/downloads.png" alt="Total Downloads"></a> <a href="https://packagist.org/packages/qxsch/worker-pool"><img src="https://poser.pugx.org/qxsch/worker-pool/license.png" alt="License"></a></p>

<p><strong>Parallel Processing WorkerPool for PHP</strong></p>

<p><em>This library is in its infancy. I am adding features to it as I require them.</em></p>

<h2>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples</h2>

<p>The WorkerPool class provides a very simple interface to pass data to a worker pool and have it processed.
You can at any time fetch the results from the workers. Each worker child can return any value that can be <a href="http://php.net/serialize">serialized</a>.</p>

<h3>
<a name="a-simple-example" class="anchor" href="#a-simple-example"><span class="octicon octicon-link"></span></a>A simple example</h3>

<div class="highlight highlight-php"><pre><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$wp</span><span class="o">=</span><span class="k">new</span> <span class="nx">\QXS\WorkerPool\WorkerPool</span><span class="p">();</span>
<span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">setWorkerPoolSize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
   <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="k">new</span> <span class="nx">\QXS\WorkerPool\ClosureWorker</span><span class="p">(</span>
                        <span class="sd">/**</span>
<span class="sd">                          * @param mixed $input the input from the WorkerPool::run() Method</span>
<span class="sd">                          * @param \QXS\WorkerPool\Semaphore $semaphore the semaphore to synchronize calls accross all workers</span>
<span class="sd">                          * @param \ArrayObject $storage a persistent storage for the current child process</span>
<span class="sd">                          */</span>
                        <span class="k">function</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="nv">$semaphore</span><span class="p">,</span> <span class="nv">$storage</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">echo</span> <span class="s2">"["</span><span class="o">.</span><span class="nb">getmypid</span><span class="p">()</span><span class="o">.</span><span class="s2">"]"</span><span class="o">.</span><span class="s2">" hi </span><span class="si">$input</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
                                <span class="nb">sleep</span><span class="p">(</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="c1">// this is the working load!</span>
                                <span class="k">return</span> <span class="nv">$input</span><span class="p">;</span> <span class="c1">// return null here, in case you do not want to pass any data to the parent </span>
                        <span class="p">}</span>
                <span class="p">)</span>
<span class="p">);</span>


<span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">waitForAllWorkers</span><span class="p">();</span> <span class="c1">// wait for all workers</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">$wp</span> <span class="k">as</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$val</span><span class="p">);</span>  <span class="c1">// dump the returned values</span>
<span class="p">}</span>

</pre></div>

<h3>
<a name="a-more-sophisticated-example" class="anchor" href="#a-more-sophisticated-example"><span class="octicon octicon-link"></span></a>A more sophisticated example</h3>

<div class="highlight highlight-php"><pre><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">use</span> <span class="nx">QXS\WorkerPool\WorkerPool</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">QXS\WorkerPool\Worker</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">QXS\WorkerPool\Semaphore</span><span class="p">;</span>


<span class="sd">/**</span>
<span class="sd"> * Our Worker Class</span>
<span class="sd"> */</span>
<span class="k">Class</span> <span class="nc">MyWorker</span> <span class="k">implements</span> <span class="nx">Worker</span> <span class="p">{</span>
        <span class="k">protected</span> <span class="nv">$sem</span><span class="p">;</span>
        <span class="sd">/**</span>
<span class="sd">         * after the worker has been forked into another process</span>
<span class="sd">         *</span>
<span class="sd">         * @param \QXS\WorkerPool\Semaphore $semaphore the semaphore to run synchronized tasks</span>
<span class="sd">         * @throws \Exception in case of a processing Error an Exception will be thrown</span>
<span class="sd">         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">onProcessCreate</span><span class="p">(</span><span class="nx">Semaphore</span> <span class="nv">$semaphore</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// semaphore can be used in the run method to synchronize the workers</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sem</span><span class="o">=</span><span class="nv">$semaphore</span><span class="p">;</span>
                <span class="c1">// write something to the stdout</span>
                <span class="k">echo</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">["</span><span class="o">.</span><span class="nb">getmypid</span><span class="p">()</span><span class="o">.</span><span class="s2">"] has been created.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
                <span class="c1">// initialize mt_rand</span>
                <span class="k">list</span><span class="p">(</span><span class="nv">$usec</span><span class="p">,</span> <span class="nv">$sec</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="nb">microtime</span><span class="p">());</span>
                <span class="nx">mt_srand</span><span class="p">(</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span> <span class="nv">$sec</span> <span class="o">+</span> <span class="p">((</span><span class="nx">float</span><span class="p">)</span> <span class="nv">$usec</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="sd">/**</span>
<span class="sd">         * before the worker process is getting destroyed</span>
<span class="sd">         *</span>
<span class="sd">         * @throws \Exception in case of a processing Error an Exception will be thrown</span>
<span class="sd">         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">onProcessDestroy</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// write something to the stdout</span>
                <span class="k">echo</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">["</span><span class="o">.</span><span class="nb">getmypid</span><span class="p">()</span><span class="o">.</span><span class="s2">"] will be destroyed.</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="sd">/**</span>
<span class="sd">         * run the work</span>
<span class="sd">         *</span>
<span class="sd">         * @param Serializeable $input the data, that the worker should process</span>
<span class="sd">         * @return Serializeable Returns the result</span>
<span class="sd">         * @throws \Exception in case of a processing Error an Exception will be thrown</span>
<span class="sd">         */</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">(</span><span class="nv">$input</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$input</span><span class="o">=</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$input</span><span class="p">;</span>
                <span class="k">echo</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">["</span><span class="o">.</span><span class="nb">getmypid</span><span class="p">()</span><span class="o">.</span><span class="s2">"] Hi </span><span class="si">$input</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
                <span class="nb">sleep</span><span class="p">(</span><span class="nx">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span> <span class="c1">// this is the workload!</span>
                <span class="c1">// and sometimes exceptions might occur</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">==</span><span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\RuntimeException</span><span class="p">(</span><span class="s1">'We have a problem for '</span><span class="o">.</span><span class="nv">$input</span><span class="o">.</span><span class="s1">'.'</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="s2">"Hi </span><span class="si">$input</span><span class="s2">"</span><span class="p">;</span> <span class="c1">// return null here, in case you do not want to pass any data to the parent</span>
        <span class="p">}</span>
<span class="p">}</span>


<span class="nv">$wp</span><span class="o">=</span><span class="k">new</span> <span class="nx">WorkerPool</span><span class="p">();</span>
<span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">setWorkerPoolSize</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
   <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyWorker</span><span class="p">());</span>

<span class="c1">// produce some tasks</span>
<span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;=</span><span class="mi">50</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="nv">$i</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// some statistics</span>
<span class="k">echo</span> <span class="s2">"Busy Workers:"</span><span class="o">.</span><span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">getBusyWorkers</span><span class="p">()</span><span class="o">.</span><span class="s2">"  Free Workers:"</span><span class="o">.</span><span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">getFreeWorkers</span><span class="p">()</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="c1">// wait for completion of all tasks</span>
<span class="nv">$wp</span><span class="o">-&gt;</span><span class="na">waitForAllWorkers</span><span class="p">();</span>

<span class="c1">// collect all the results</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$wp</span> <span class="k">as</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">echo</span> <span class="s2">"RESULT: "</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">elseif</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'workerException'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">echo</span> <span class="s2">"WORKER EXCEPTION: "</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'workerException'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span><span class="o">.</span><span class="s2">": "</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'workerException'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'workerException'</span><span class="p">][</span><span class="s1">'trace'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">elseif</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'poolException'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">echo</span> <span class="s2">"POOL EXCEPTION: "</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'poolException'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span><span class="o">.</span><span class="s2">": "</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'poolException'</span><span class="p">][</span><span class="s1">'message'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="nv">$val</span><span class="p">[</span><span class="s1">'poolException'</span><span class="p">][</span><span class="s1">'trace'</span><span class="p">]</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// write something, before the parent exits</span>
<span class="k">echo</span> <span class="s2">"ByeBye</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

</pre></div>

<h3>
<a name="transparent-output-to-ps" class="anchor" href="#transparent-output-to-ps"><span class="octicon octicon-link"></span></a>Transparent output to ps</h3>

<p>See what's happening when running a PS:</p>

<pre><code>root   2378   \_ simpleExample.php: Parent
root   2379       \_ simpleExample.php: Worker 1 of QXS\WorkerPool\ClosureWorker [busy]
root   2380       \_ simpleExample.php: Worker 2 of QXS\WorkerPool\ClosureWorker [busy]
root   2381       \_ simpleExample.php: Worker 3 of QXS\WorkerPool\ClosureWorker [free]
root   2382       \_ simpleExample.php: Worker 4 of QXS\WorkerPool\ClosureWorker [free]
</code></pre>

<h3>
<a name="documentation" class="anchor" href="#documentation"><span class="octicon octicon-link"></span></a>Documentation</h3>

<p>The documentation can be found here <a href="http://qxsch.github.io/WorkerPool/doc/">http://qxsch.github.io/WorkerPool/doc/</a></p>
        </section>

        <footer>
          Workerpool is maintained by <a href="https://github.com/qxsch">qxsch</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>